# 音频源选择功能说明

## 功能概述

WebServer 现已支持音频输入源选择功能，允许用户在监控"音频响度"模式时选择要监听的音频设备。

## 功能特点

1. **自动检测音频设备** - 系统会自动列出所有可用的音频输入设备
2. **支持多种设备类型**:
   - 🔊 系统音频回放设备（Loopback/Monitor）- 用于监听系统播放的音频
   - 🎤 麦克风输入设备 - 用于监听外部音频输入
3. **智能默认选择** - 如果不选择设备，系统会自动选择最合适的音频源
4. **配置持久化** - 用户选择的设备会保存到配置文件，下次启动自动恢复
5. **热切换支持** - 在监控运行时可以切换音频源，无需停止监控

## 使用方法

### 1. 启用音频响度监控

1. 在"监控配置"卡片中，选择监控模式为 **"音频响度"**
2. 此时会自动显示两个新的配置项：
   - **dB映射** - 设置音频响度的分贝范围映射
   - **音频输入** - 选择要监听的音频设备

### 2. 选择音频设备

1. 点击 **"音频输入"** 下拉框
2. 系统会列出所有可用的音频设备：
   - 带 🔊 图标的是系统音频回放设备（推荐用于监听音乐、视频等）
   - 没有图标的是麦克风等输入设备
3. 选择您想要监听的设备
4. 选择后会自动保存到配置文件

### 3. 刷新设备列表

如果插拔了音频设备，可以点击音频输入框右侧的刷新按钮 🔄 重新扫描设备。

### 4. 自动选择模式

如果选择 **"自动选择..."**，系统会按以下优先级自动选择：
1. Windows：系统默认扬声器的回放监听
2. Linux：PulseAudio Monitor 设备
3. 后备方案：默认麦克风

## API 接口

### 获取音频设备列表

```http
GET /api/audio/devices
```

**响应示例：**
```json
{
  "success": true,
  "devices": [
    {
      "id": "device_id_1",
      "name": "扬声器 (Realtek High Definition Audio)",
      "channels": 2,
      "is_loopback": true
    },
    {
      "id": "device_id_2",
      "name": "麦克风 (USB Audio Device)",
      "channels": 1,
      "is_loopback": false
    }
  ]
}
```

### 选择音频设备

```http
POST /api/audio/select
Content-Type: application/json

{
  "device_id": "device_id_1"  // 或 null 表示自动选择
}
```

**响应示例：**
```json
{
  "success": true,
  "device_id": "device_id_1"
}
```

### 查询当前选择的设备

```http
GET /api/status
```

**响应中会包含：**
```json
{
  "audio_device_id": "device_id_1",  // null 表示自动选择
  ...
}
```

## 技术实现

### 后端修改

1. **state.py** - 添加 `audio_device_id` 字段用于保存用户选择
2. **monitor.py** - 修改 `init_audio_meter()` 支持指定设备初始化
3. **routes.py** - 添加 `/api/audio/devices` 和 `/api/audio/select` 接口

### 前端修改

1. **index.html** - 在监控配置卡片添加音频设备选择下拉框
2. **app.js** - 添加设备列表获取、设备切换等逻辑

## 注意事项

1. **soundcard 库依赖** - 此功能需要 `soundcard` 库支持，如果库不可用，音频响度功能将不可用
2. **平台差异**:
   - Windows：支持系统音频回放监听（Loopback）
   - Linux：需要 PulseAudio，支持 Monitor 设备
   - macOS：取决于 soundcard 库的支持情况
3. **设备变化** - 如果在监控运行时拔出正在使用的音频设备，可能导致监控异常，建议先停止监控再更换设备

## 故障排除

### 没有显示音频输入选择框
- 确认监控模式已选择为"音频响度"
- 刷新页面重新加载配置

### 设备列表为空
- 检查是否安装了 soundcard 库：`pip install soundcard`
- 确认系统有可用的音频设备
- 检查浏览器控制台是否有错误信息

### 切换设备后没有反应
- 如果正在监控，系统会自动重启音频监控
- 检查终端输出是否有初始化错误信息
- 尝试手动停止监控后重新开始

## 版本信息

- 添加时间：2026-01-09
- 版本要求：DutyCycle Studio v1.0+
